# analyze.gene.enrichment.R
# 

# Functions ---------------------------------------------------------------
source("scripts/functions/AnalyzeGeneEnrichment.R")

RemoveExtension <- function(fname){
  # removes any .txt or .pdf, returns the fname without the extension
  fname.split <- strsplit(fname, '\\.')
  # remove last element from split string
  fname.split <- fname.split[[1]][-length(fname.split[[1]])]
  
  # reassemble any potential dots in filename from before
  fname.noext <- paste(fname.split, collapse = ".")
  return(fname.noext)
}

# Loop through file names and get gene enrichment -------------------------

fnames <- read.table("plots/nconds/7_conds_filtered/files.txt", )  # full file paths
fnames <- as.character(unlist(fnames))  # loop-able

genes.bg <- read.table("plots/nconds/7_conds_filtered/filtered_genes.txt")
genes.bg <- as.character(unlist(genes.bg))

# precalculation of these objs makes things go faster
sym2entrez <- CreateSym2Entrez()
entrez2GO <- CreateEntrez2GO()

for (fname in fnames){
  genes.hit <- read.table(fname)
  genes.hit <- as.character(unlist(genes.hit))
  # Run ontologies for MF, BP and CC
  for (onto in c("BP", "MF", "CC")){
    fname.noext <- RemoveExtension(fname)
    fname.out <- paste0(fname.noext, '_', onto)
    res <- AnalyzeGeneEnrichment(genes.bg, genes.hit, 
                                 sym2entrez, entrez2GO, 
                                 convert.sym.to.entrez = TRUE, 
                                 which.ontology = onto, 
                                 write.path = fname.out, 
                                 node.size = 5, 
                                 FDR.cutoff = 0.05)
  }
}